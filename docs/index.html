<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mini Royal Match - Mboka_mj</title>

  <style>
    /* Int√©gration locale de la police Luckiest Guy */
    @font-face {
      font-family: 'Luckiest Guy';
      font-style: normal;
      font-weight: 400;
      src: url('fonts/luckiestguy.ttf') format('truetype');
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      margin: 0; padding: 0; color: #fff;
      overflow: hidden;
    }
    #game-container {
      background: none;
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    h1 { margin: 10px; font-size: 28px; text-shadow: 2px 2px 5px rgba(0,0,0,0.3); color: #fff; }
    #hud {
      margin: 10px auto; font-size: 18px;
      display: flex; justify-content: space-around;
      background: rgba(0,0,0,0.3); padding: 10px;
      border-radius: 10px; max-width: 500px;
    }
    #grid {
      display: grid; gap: 4px;
      justify-content: center; margin: 15px auto; padding: 10px;
      background: rgba(255,255,255,0.2); border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }
    .cell {
      width: 55px; height: 55px;
      font-size: 30px; display: flex;
      align-items: center; justify-content: center;
      border-radius: 12px; background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer;
      transition: transform 0.15s, background 0.2s;
    }
    .cell.selected { transform: scale(1.15); background: #ffeaa7; border: 2px solid #ffbe76; }
    .cell.hidden-cell { visibility: hidden; }
    .cell.bomb { background: #ff7675; font-size: 32px; }
    .cell.chest { background: #ffd700; }
    .cell.rocket { background: #9b59b6; font-size: 32px; }
    .cell.disco { background: #f1c40f; font-size: 32px; }
    /* La classe .cell.box a √©t√© supprim√©e */

    .exploding { animation: explode 0.3s ease-out; }
    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.4); opacity: 0.6; }
      100% { transform: scale(0); opacity: 0; }
    }
    .clearing-row { animation: clear-row 0.5s forwards; }
    @keyframes clear-row {
      from { transform: scale(1); opacity: 1; }
      to { transform: translateX(100vw) scale(0) opacity: 0; }
    }
    .clearing-col { animation: clear-col 0.5s forwards; }
    @keyframes clear-col {
      from { transform: scale(1); opacity: 1; }
      to { transform: translateY(100vh) scale(0) opacity: 0; }
    }

    #buttons { margin: 15px; }
    button {
      margin: 5px; padding: 10px 20px;
      border: none; border-radius: 8px;
      background: #00cec9; color: white; font-size: 16px;
      cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    button:hover { background: #55efc4; }
    #message { font-size: 22px; margin: 15px; font-weight: bold; text-shadow: 2px 2px 6px rgba(0,0,0,0.4); }
    #welcome {
      margin-top: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadein 2s ease-in-out infinite alternate;
    }
    @keyframes fadein {
      from { opacity: 0.4; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1.05); }
    }

    /* Styles Royal Match */
    .hud-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 90%;
      max-width: 900px;
      margin: 20px auto;
      font-family: 'Luckiest Guy', cursive;
      text-transform: uppercase;
      color: #fff;
      flex-wrap: wrap;
    }
    .info-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 20px;
      border-radius: 25px;
      border: 3px solid #fff;
      background: linear-gradient(180deg, #51a4e2, #25608d);
      box-shadow: 0 5px 10px rgba(0,0,0,0.4);
      min-width: 100px;
      margin: 5px;
      flex: 1;
    }
    .info-panel span {
      font-size: 28px;
      margin-top: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .info-panel div:first-child {
      font-size: 14px;
      opacity: 0.8;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .hud-title {
        font-family: 'Luckiest Guy', cursive;
        text-transform: uppercase;
        font-size: 32px;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        margin: 10px auto;
        color: #fff;
        line-height: 1.2;
    }

    .info-panel.combo { animation: score-vibrate 0.4s ease-in-out; }
    .info-panel.stars-panel span { font-size: 32px; }
    .info-panel.target-panel { position: relative; }
    .target-progress {
        position: absolute;
        bottom: 0; left: 0;
        width: 100%;
        height: 10px;
        background-color: #f39c12;
        border-bottom-left-radius: 22px;
        border-bottom-right-radius: 22px;
        transition: width 0.3s ease-in-out;
    }

    @keyframes score-vibrate {
      0% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(0.95); }
      75% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <div id="game-container">
    <div id="welcome">
      <h1 class="hud-title">Bienvenue √† Mini Royal Match - Mboka_mj !<br>Appuyez sur le bouton pour d√©marrer l'aventure.</h1>
      <p id="countdown-message"></p>
      <button id="startBtn">Commencer le jeu</button>
    </div>

    <div id="game" style="display:none;">
      <h1 class="hud-title">Mini Royal Match - Mboka_mj</h1>
      <div class="hud-bar">
        <div class="info-panel">
          <div>Score</div>
          <span id="score">0</span>
        </div>
        <div class="info-panel lives-panel">
          <div>Vies</div>
          <span id="lives-display"></span>
        </div>
        <div class="info-panel">
          <div>Niveau</div>
          <span id="level">1</span>
        </div>
        <div class="info-panel target-panel">
          <div>Cible</div>
          <span id="target">100</span>
          <div class="target-progress"></div>
        </div>
        <div class="info-panel">
          <div>Temps</div>
          <span id="timer">90</span>
        </div>
        <div class="info-panel stars-panel">
          <div>√âtoiles</div>
          <span id="stars-display"></span>
        </div>
      </div>
      <div id="grid"></div>
      <div id="buttons">
        <button id="buyLifeBtn">Acheter une vie (2‚≠êÔ∏è)</button>
        <button id="newBtn">Nouvelle Partie</button>
        <button id="useBombBtn" style="display:none;">Utiliser une Bombe (<span id="bombCount">0</span>)</button>
        <button id="useRocketBtn" style="display:none;">Utiliser une Fus√©e (<span id="rocketCount">0</span>)</button>
        <button id="useDiscoBtn" style="display:none;">Utiliser une Boule Disco (<span id="discoCount">0</span>)</button>
      </div>
      <div id="message"></div>
    </div>
  </div>

<script>
  const BASE_TIME = 90;
  const BASE_TARGET = 100;
  const SCORE_PER_TILE = 2;
  const SCORE_PER_BOMB_TILE = 1;
  const SCORE_PER_ROCKET_TILE = 1;
  const MAX_BOMBS = 3;
  const CHEST_TRIGGER_SCORE = 50;
  const CHEST_BOMBS_COUNT = 5;
  const BOMB_TILES_DESTROYED = 3;
  const STAR_COST_FOR_LIFE = 2;
  const REGENERATION_TIME = 20 * 60 * 1000;

  const ICON_SETS = [
    ['üçì','üçä','üçã','üçé','üçâ'],
    ['üíé','üî∑','üî∂','üî∫','üîπ'],
    ['üåü','üî•','‚ö°','‚ùÑÔ∏è','‚òòÔ∏è'],
    ['üê±','üê∂','üê∏','üêµ','üêº']
  ];

  const LEVEL_CONFIGS = [
    { name: "Carr√© 8x8", rows: 8, cols: 8, hiddenCells: []},
    { name: "Rectangle 9x7", rows: 9, cols: 7, hiddenCells: []},
    { name: "Triangle", rows: 8, cols: 8, hiddenCells: [
      [0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],
      [1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[2,0],
      [2,1],[2,2],[2,3],[2,4],[2,5],[3,0],[3,1],[3,2],
      [3,3],[3,4],[4,0],[4,1],[4,2],[4,3],[5,0],[5,1],
      [5,2],[6,0],[6,1],[7,0]
    ]},
    { name: "Croix", rows: 8, cols: 8, hiddenCells: [
      [0,0],[0,1],[0,6],[0,7],
      [1,0],[1,1],[1,6],[1,7],
      [6,0],[6,1],[6,6],[6,7],
      [7,0],[7,1],[7,6],[7,7]
    ]}
  ];

  let ROWS, COLS, board=[], selected=null;
  let score=0, level=1, target=BASE_TARGET, timeLeft=BASE_TIME;
  let timerInterval=null, animating=false, bombsUsed=0;
  let bombTimer=null, bombsInStock = 0;
  let rocketsInStock = 0;
  let discoInStock = 0;
  let nextChestScore = CHEST_TRIGGER_SCORE;
  let isUsingBomb = false, isUsingRocket = false, isUsingDisco = false;
  let levelCompleted = false;
  let chestsSpawned = 0;
  let stars = 0;
  let lives = 3;
  let regenerationInterval = null;
  let levelConfig;

  function randInt(n){ return Math.floor(Math.random()*n); }
  function wait(ms){ return new Promise(res=>setTimeout(res,ms)); }

  function createBoard(){
    board = [];
    for(let r=0;r<ROWS;r++){
      let row=[];
      for(let c=0;c<COLS;c++){
        if(isHidden(r,c)) row.push(null);
        else {
          row.push( randomIcon() );
        }
      }
      board.push(row);
    }
    removeMatchesInit();
  }

  function randomIcon(){
    let icons = ICON_SETS[Math.min(level-1, ICON_SETS.length -1)];
    return icons[randInt(icons.length)];
  }

  function isHidden(r,c){
    return levelConfig.hiddenCells.some(([hr,hc])=>hr===r && hc===c);
  }

  function renderBoard(){
    const grid=document.getElementById("grid");
    grid.innerHTML="";
    grid.style.gridTemplateColumns=`repeat(${COLS},55px)`;
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const cell=document.createElement("div");
        cell.className="cell";
        if(board[r][c]===null){
          cell.classList.add("hidden-cell");
        } else {
          cell.textContent=board[r][c];
          if(board[r][c]==="üí£") cell.classList.add("bomb");
          if(board[r][c]==="üéÅ") cell.classList.add("chest");
          if(board[r][c]==="üöÄ") cell.classList.add("rocket");
          if(board[r][c]==="üåà") cell.classList.add("disco");
          cell.onclick=()=>selectCellWrapper(r,c,cell);
        }
        grid.appendChild(cell);
      }
    }
  }

  function selectCell(r,c,el){
    if(animating || board[r][c]==null) return;
    if(selected==null){
      selected={r,c,el}; el.classList.add("selected");
    }else{
      if(r===selected.r && c===selected.c){
        selected.el.classList.remove("selected");
        selected=null; return;
      }
      swapAndCheck(selected.r,selected.c,r,c);
      selected.el.classList.remove("selected");
      selected=null;
    }
  }

  async function swapAndCheck(r1,c1,r2,c2){
    if(Math.abs(r1-r2)+Math.abs(c1-c2)!==1) return;
    
    [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
    
    const initialMatches = findMatches();
    if(initialMatches.matches.length===0){
      [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
      return;
    }
    
    renderBoard();
    await handleMatches(initialMatches);
  }

  function findMatches(){
    let matches=[];
    let specialCreates = [];
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
          if (c + 2 < COLS && board[r][c] !== null && board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) {
              let startC = c;
              let len = 0;
              while (startC + len < COLS && board[r][c] === board[r][startC+len]) {
                  len++;
              }
              matches.push({r,c,len,dir:"row", type: board[r][c]});
              if (len >= 4) { specialCreates.push({ r: r, c: c + Math.floor(len / 2), type: len >= 5 ? "üåà" : "üöÄ" }); }
              c += len - 1;
          }
      }
    }
    for(let c=0;c<COLS;c++){
      for(let r=0;r<ROWS;r++){
          if (r + 2 < ROWS && board[r][c] !== null && board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) {
              let startR = r;
              let len = 0;
              while (startR + len < ROWS && board[r][c] === board[startR+len][c]) {
                  len++;
              }
              matches.push({r,c,len,dir:"col", type: board[r][c]});
              if (len >= 4) { specialCreates.push({ r: r + Math.floor(len / 2), c: c, type: len >= 5 ? "üåà" : "üöÄ" }); }
              r += len - 1;
          }
      }
    }
    return { matches, specialCreates };
  }
  
  async function handleMatches(initialMatches = null){
    animating=true;
    let { matches, specialCreates } = initialMatches || findMatches();
    while(matches.length>0){
      const scorePanel = document.getElementById("score").parentElement;
      scorePanel.classList.add("combo");
      
      for(const m of matches){
        for(let i=0;i<m.len;i++){
          let rr=m.r+(m.dir==="row"?0:i);
          let cc=m.c+(m.dir==="col"?0:i);
          if(board[rr][cc] != "üí£" && board[rr][cc] != "üöÄ" && board[rr][cc] != "üåà" && board[rr][cc] != "üéÅ"){
            board[rr][cc] = null;
          }
        }
        score += m.len * SCORE_PER_TILE;
      }

      for (const special of specialCreates) {
          if (board[special.r][special.c] !== null) {
              if (special.type === "üåà") discoInStock++;
              else if (special.type === "üöÄ") rocketsInStock++;
              board[special.r][special.c] = special.type;
          }
      }
      
      updateHUD();
      
      renderBoard();
      await wait(300);
      
      scorePanel.classList.remove("combo");
      applyGravity();
      renderBoard();
      await wait(200);
      let nextMatches = findMatches();
      matches = nextMatches.matches;
      specialCreates = nextMatches.specialCreates;
    }
    checkWin();
    animating=false;
  }

  function explodeBomb(r,c){
    let destroyedCount = 0;
    let cellsToExplode = [];
    for(let dr=-1;dr<=1;dr++){
      for(let dc=-1;dc<=1;dc++){
        let nr=r+dr, nc=c+dc;
        if(nr>=0 && nr<ROWS && nc>=0 && nc<COLS && board[nr][nc]!=null){
          if(board[nr][nc] !== "üéÅ" && board[nr][nc] !== "üí£" && board[nr][nc] !== "üöÄ" && board[nr][nc] !== "üåà"){
            cellsToExplode.push({r: nr, c: nc});
          }
        }
      }
    }
    
    cellsToExplode.forEach(cell => {
      board[cell.r][cell.c] = null;
      destroyedCount++;
    });
    
    score += destroyedCount * SCORE_PER_BOMB_TILE;
    document.getElementById("message").textContent = `üí£ ${destroyedCount} tuiles d√©truites !`;
    applyGravity();
    renderBoard();
    checkWin();
  }
  
  function explodeRocket(r,c, direction){
    let cellsToExplode = [];
    if(direction === "row"){
      for(let j=0; j<COLS; j++) cellsToExplode.push({r, c: j});
    } else {
      for(let i=0; i<ROWS; i++) cellsToExplode.push({r: i, c});
    }
    
    let destroyedCount = 0;
    cellsToExplode.forEach(cell => {
      board[cell.r][cell.c] = null;
      destroyedCount++;
    });
    score += destroyedCount * SCORE_PER_ROCKET_TILE;
    document.getElementById("message").textContent = `üöÄ Ligne / Colonne d√©truite !`;
    applyGravity();
    renderBoard();
    checkWin();
  }
  
  function explodeDisco(r, c){
    const targetIcon = board[r][c];
    let cellsToExplode = [];
    for(let i=0; i<ROWS; i++){
      for(let j=0; j<COLS; j++){
        if(board[i][j] === targetIcon){
          cellsToExplode.push({r: i, c: j});
        }
      }
    }
    
    let destroyedCount = 0;
    cellsToExplode.forEach(cell => {
      board[cell.r][cell.c] = null;
      destroyedCount++;
    });
    score += destroyedCount * SCORE_PER_ROCKET_TILE;
    document.getElementById("message").textContent = `üåà Toutes les tuiles ${targetIcon} ont explos√© !`;
    applyGravity();
    renderBoard();
    checkWin();
  }

  function applyGravity(){
    for(let c=0;c<COLS;c++){
      for(let r=ROWS-1;r>=0;r--){
        if(board[r][c]===null && !isHidden(r,c)){
          for(let rr=r-1;rr>=0;rr--){
            if(board[rr][c]!=null){
              board[r][c]=board[rr][c];
              board[rr][c]=null;
              break;
            }
          }
          if(board[r][c]===null) board[r][c]=randomIcon();
        }
      }
    }
  }

  function removeMatchesInit(){
    let { matches } = findMatches();
    while(matches.length>0){
      for(const match of matches){
        for(let i=0;i<match.len;i++){
          let rr=match.r+(match.dir==="row"?0:i);
          let cc=match.c+(match.dir==="col"?0:i);
          board[rr][cc]=randomIcon();
        }
      }
      ({ matches } = findMatches());
    }
  }
  
  function bombsOnBoard(){
    let count = 0;
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        if(board[r][c]==="üí£") count++;
      }
    }
    return count;
  }

  function startLevel(){
    clearInterval(timerInterval);
    if(bombTimer){ clearTimeout(bombTimer); bombTimer=null; }
    
    const idx = Math.min(level - 1, LEVEL_CONFIGS.length - 1);
    levelConfig = LEVEL_CONFIGS[idx];
    ROWS = levelConfig.rows;
    COLS = levelConfig.cols;

    score = 0;
    bombsUsed = 0;
    timeLeft = Math.max(BASE_TIME - (level-1) * 10, 30);
    target = BASE_TARGET + (level-1) * 10;
    nextChestScore = score + CHEST_TRIGGER_SCORE;
    isUsingBomb = false;
    isUsingRocket = false;
    isUsingDisco = false;
    levelCompleted = false;
    chestsSpawned = 0;

    createBoard();
    renderBoard();

    updateHUD();
    document.getElementById("message").textContent = "";
    
    startTimer();
    
    if(level >= 3){
      bombTimer = setTimeout(function bombLoop(){
        if(bombsOnBoard()<MAX_BOMBS) spawnSpecial("üí£");
        if(bombsOnBoard()<MAX_BOMBS) bombTimer=setTimeout(bombLoop,60000);
        else bombTimer=null;
      },60000);
    }
  }
  
  function spawnSpecial(icon){
    let r, c;
    do {
      r = randInt(ROWS);
      c = randInt(COLS);
    } while (board[r][c] === null || board[r][c] === "üí£" || board[r][c] === "üéÅ" || board[r][c] === "üöÄ" || board[r][c] === "üåà");
    board[r][c] = icon;
    renderBoard();
  }
  
  function selectCellWrapper(r,c,el){
    if(animating || board[r][c]===null) return;
    
    if(isUsingBomb){
      explodeBomb(r, c);
      isUsingBomb = false;
      bombsInStock--;
      document.getElementById("bombCount").textContent = bombsInStock;
      if(bombsInStock === 0) {
        document.getElementById("useBombBtn").style.display = 'none';
      }
      return;
    }
    
    if(isUsingRocket){
      explodeRocket(r, c, "row");
      isUsingRocket = false;
      rocketsInStock--;
      document.getElementById("rocketCount").textContent = rocketsInStock;
      if(rocketsInStock === 0) {
        document.getElementById("useRocketBtn").style.display = 'none';
      }
      return;
    }
    
    if(isUsingDisco){
      explodeDisco(r, c);
      isUsingDisco = false;
      discoInStock--;
      document.getElementById("useDiscoBtn").style.display = 'none';
      return;
    }
    
    if(board[r][c]==="üí£"){
      explodeBomb(r,c);
      return;
    }
    
    if(board[r][c]==="üéÅ"){
      bombsInStock += CHEST_BOMBS_COUNT;
      document.getElementById("message").textContent = `üéÅ Coffre ouvert ! +${CHEST_BOMBS_COUNT} bombes !`;
      board[r][c] = null;
      renderBoard();
      applyGravity();
      return;
    }
    
    selectCell(r,c,el);
  }

  function startTimer(){
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      timeLeft--;
      updateHUD();
      if(timeLeft<=0) endGame(false);
    },1000);
  }

  function endGame(win){
    clearInterval(timerInterval);
    if(bombTimer){ clearTimeout(bombTimer); bombTimer=null; }

    if(win){
      document.getElementById("message").textContent="üéâ Victoire ! Niveau " + level + " termin√© !";
      stars++;
      saveGame();
      level++;
      setTimeout(startLevel, 2000);
    } else {
      lives--;
      document.getElementById("message").textContent="‚è≥ Temps √©coul√© ! Perdu.";

      if(lives > 0){
        document.getElementById("message").textContent += " Il vous reste " + lives + " vies.";
        saveGame();
        setTimeout(startLevel, 2000);
      } else {
        document.getElementById("message").textContent += " Vous n'avez plus de vies. Attendez 20 minutes pour en r√©cup√©rer 3.";
        saveGame();
        const regenerationTime = Date.now() + REGENERATION_TIME;
        localStorage.setItem('regenerationTime', regenerationTime);
        
        document.getElementById("game").style.display = "none";
        document.getElementById("welcome").style.display = "block";
        document.getElementById("startBtn").disabled = true;
        startRegenerationCountdown(regenerationTime);
      }
    }
    updateHUD();
  }

  function checkWin(){
    if(score >= target && !levelCompleted) {
      levelCompleted = true;
      endGame(true);
    }
  }

  function saveGame() {
    const gameState = {
      level: level,
      bombsInStock: bombsInStock,
      rocketsInStock: rocketsInStock,
      discoInStock: discoInStock,
      stars: stars,
      lives: lives
    };
    localStorage.setItem('royalMatchSave', JSON.stringify(gameState));
  }

  function loadGame() {
    const savedState = localStorage.getItem('royalMatchSave');
    if (savedState) {
      const gameState = JSON.parse(savedState);
      level = gameState.level;
      bombsInStock = gameState.bombsInStock || 0;
      rocketsInStock = gameState.rocketsInStock || 0;
      discoInStock = gameState.discoInStock || 0;
      stars = gameState.stars || 0;
      lives = gameState.lives || 3;
      return true;
    }
    return false;
  }

  function updateHUD() {
    document.getElementById("score").textContent = score;
    document.getElementById("level").textContent = level;
    document.getElementById("target").textContent = target;
    document.getElementById("timer").textContent = timeLeft;
    
    const progress = Math.min(100, (score / target) * 100);
    document.querySelector('.target-progress').style.width = `${progress}%`;
    
    document.getElementById("bombCount").textContent = bombsInStock;
    document.getElementById("rocketCount").textContent = rocketsInStock;
    document.getElementById("discoCount").textContent = discoInStock;
    
    const livesDisplay = document.getElementById("lives-display");
    livesDisplay.textContent = "‚ù§Ô∏è".repeat(lives);

    const starsDisplay = document.getElementById("stars-display");
    starsDisplay.textContent = "‚≠êÔ∏è x" + stars;
    
    document.getElementById("buyLifeBtn").disabled = stars < STAR_COST_FOR_LIFE;
    document.getElementById("useBombBtn").style.display = bombsInStock > 0 ? 'inline-block' : 'none';
    document.getElementById("useRocketBtn").style.display = rocketsInStock > 0 ? 'inline-block' : 'none';
    document.getElementById("useDiscoBtn").style.display = discoInStock > 0 ? 'inline-block' : 'none';
  }

  function startRegenerationCountdown(regenerationTime) {
      clearInterval(regenerationInterval);
      regenerationInterval = setInterval(() => {
          const timeLeft = Math.floor((regenerationTime - Date.now()) / 1000);
          if (timeLeft <= 0) {
              clearInterval(regenerationInterval);
              localStorage.removeItem('regenerationTime');
              lives = 3;
              document.getElementById("countdown-message").textContent = "Vos vies sont r√©g√©n√©r√©es !";
              document.getElementById("startBtn").disabled = false;
              saveGame();
              updateHUD();
          } else {
              const minutes = Math.floor(timeLeft / 60);
              const seconds = timeLeft % 60;
              document.getElementById("countdown-message").textContent = `Vies √©puis√©es. R√©g√©n√©ration dans ${minutes}m ${seconds}s`;
          }
      }, 1000);
  }

  document.getElementById("startBtn").onclick=()=>{
    const regenerationTime = localStorage.getItem('regenerationTime');
    if (regenerationTime && Date.now() < regenerationTime) {
        startRegenerationCountdown(regenerationTime);
        document.getElementById("startBtn").disabled = true;
        return;
    }

    document.getElementById("welcome").style.display="none";
    document.getElementById("game").style.display="block";
    if (loadGame()) {
      document.getElementById("message").textContent = "Partie charg√©e ! Reprenez l√† o√π vous vous √©tiez arr√™t√©.";
    }
    updateHUD();
    startLevel();
  };

  document.getElementById("newBtn").onclick=()=>{
    score=0;
    level=1;
    bombsInStock=0;
    rocketsInStock=0;
    discoInStock=0;
    stars=0;
    localStorage.removeItem('royalMatchSave');
    localStorage.removeItem('regenerationTime');
    updateHUD();
    startLevel();
  };
  
  document.getElementById("useBombBtn").onclick = () => {
    if(bombsInStock > 0){
      isUsingBomb = true;
      document.getElementById("message").textContent = "Cliquez sur une tuile pour utiliser une bombe !";
    }
  };

  document.getElementById("useRocketBtn").onclick = () => {
    if(rocketsInStock > 0){
      isUsingRocket = true;
      document.getElementById("message").textContent = "Cliquez sur une tuile pour utiliser une fus√©e !";
    }
  };

  document.getElementById("useDiscoBtn").onclick = () => {
    if(discoInStock > 0){
      isUsingDisco = true;
      document.getElementById("message").textContent = "Cliquez sur une tuile pour utiliser la boule disco !";
    }
  };

  document.getElementById("buyLifeBtn").onclick = () => {
      if (stars >= STAR_COST_FOR_LIFE) {
          stars -= STAR_COST_FOR_LIFE;
          lives++;
          document.getElementById("message").textContent = "Vous avez achet√© une vie ! Il vous reste " + lives + " vies.";
          updateHUD();
          saveGame();
      } else {
          document.getElementById("message").textContent = "Pas assez d'√©toiles pour acheter une vie !";
      }
  };
</script>

<script>
  // Enregistrement simple du service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').then(function(registration) {
        console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
      }, function(err) {
        console.log('Erreur d‚Äôenregistrement du Service Worker:', err);
      });
    });
  }
</script>
</body>
</html>
